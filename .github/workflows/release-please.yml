name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  build-plugin:
    name: Build Decky Plugin
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release-please.outputs.tag_name }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        run: npm install -g pnpm@9

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        run: pnpm run build

      - name: Package plugin
        run: |
          PLUGIN_NAME="CapyDeploy"
          BUILD_DIR="/tmp/decky-build/$PLUGIN_NAME"
          mkdir -p "$BUILD_DIR"

          cp plugin.json "$BUILD_DIR/"
          cp package.json "$BUILD_DIR/"
          for pyfile in main.py steam_utils.py mdns_service.py pairing.py upload.py artwork.py ws_server.py telemetry.py console_log.py game_log.py; do
            cp "$pyfile" "$BUILD_DIR/"
          done
          if [ -d "bin" ]; then
            cp -r bin "$BUILD_DIR/"
            chmod +x "$BUILD_DIR/bin/"*.sh
          fi
          cp requirements.txt "$BUILD_DIR/"
          cp -r py_modules "$BUILD_DIR/"
          cp -r dist "$BUILD_DIR/"
          if [ -d "assets" ]; then cp -r assets "$BUILD_DIR/"; fi
          if [ -f "LICENSE" ]; then cp LICENSE "$BUILD_DIR/"; fi

          cd /tmp/decky-build
          zip -r "$GITHUB_WORKSPACE/CapyDeploy.zip" "$PLUGIN_NAME"

      - name: Upload release asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "${{ needs.release-please.outputs.tag_name }}" \
            "CapyDeploy.zip" \
            --clobber

  store-submit:
    name: Submit to Decky Plugin Store
    needs: [release-please, build-plugin]
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Clone plugin database fork
        env:
          GH_TOKEN: ${{ secrets.STORE_SUBMIT_TOKEN }}
        run: |
          git clone https://x-access-token:${GH_TOKEN}@github.com/lobinuxsoft/decky-plugin-database.git db
          cd db
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync fork with upstream
        working-directory: db
        env:
          GH_TOKEN: ${{ secrets.STORE_SUBMIT_TOKEN }}
        run: |
          git remote add upstream https://github.com/SteamDeckHomebrew/decky-plugin-database.git
          git fetch upstream main
          git reset --hard upstream/main

      - name: Update submodule to new tag
        working-directory: db
        run: |
          TAG="${{ needs.release-please.outputs.tag_name }}"
          VERSION="${{ needs.release-please.outputs.version }}"

          if [ -d "plugins/CapyDeploy" ] && git submodule status plugins/CapyDeploy &>/dev/null; then
            # Existing submodule — update it
            git submodule update --init plugins/CapyDeploy
            cd plugins/CapyDeploy
            git fetch origin
            git checkout "$TAG"
            cd ../..
          else
            # First time — add as new submodule
            git submodule add https://github.com/lobinuxsoft/decky-capydeploy.git plugins/CapyDeploy
            cd plugins/CapyDeploy
            git fetch origin
            git checkout "$TAG"
            cd ../..
          fi

          git add plugins/CapyDeploy .gitmodules
          git commit -m "feat: update CapyDeploy to ${TAG}"

      - name: Push and create PR
        working-directory: db
        env:
          GH_TOKEN: ${{ secrets.STORE_SUBMIT_TOKEN }}
        run: |
          TAG="${{ needs.release-please.outputs.tag_name }}"
          VERSION="${{ needs.release-please.outputs.version }}"
          BRANCH="update-capydeploy-${VERSION}"

          git checkout -b "$BRANCH"
          git push -u origin "$BRANCH" --force

          gh pr create \
            --repo SteamDeckHomebrew/decky-plugin-database \
            --base main \
            --head "lobinuxsoft:${BRANCH}" \
            --title "Update CapyDeploy to ${TAG}" \
            --body "$(cat <<EOF
          # Update CapyDeploy to ${TAG}

          Automated update of the CapyDeploy plugin submodule to ${TAG}.

          **Changelog:** https://github.com/lobinuxsoft/decky-capydeploy/releases/tag/${TAG}

          ## Task Checklist

          ### Developer

          - [x] I am the original author or an authorized maintainer of this plugin.
          - [x] I have updated my plugin's \`package.json\` version.

          ### Plugin

          - [x] I have verified that my plugin works properly on the Stable and Beta update channels of SteamOS.

          ### Community

          - [ ] I have tested and left feedback on two other [pull requests][pulls] for new or updating plugins.

          ## Testing

          - [ ] Tested by a third party on SteamOS Stable or Beta update channel.

          [pulls]: https://github.com/steamdeckHomebrew/decky-plugin-database/pulls?q=is%3Apr+is%3Aopen+sort%3Acreated-desc+-status%3Afailure+-draft%3Atrue+-author%3A%40me
          EOF
          )"
